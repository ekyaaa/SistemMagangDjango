{% extends "layouts/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
            <main class="flex-1 overflow-y-auto p-6 lg:p-8">
                
                <!-- Stats Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Card 1 -->
                    <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Total Pendaftar</p>
                                <h3 id="totalPendaftar" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <span id="perubahanPendaftar" class="text-green-500 font-medium flex items-center gap-1">
                                <i data-lucide="trending-up" class="w-3 h-3"></i> +0%
                            </span>
                            <span class="text-slate-400 ml-2">dari bulan lalu</span>
                        </div>
                    </div>

                    <!-- Card 2 -->
                    <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Lowongan Aktif</p>
                                <h3 id="lowonganAktif" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                                <i data-lucide="briefcase" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="text-slate-500 font-medium">
                                <span id="deptAktif">0</span> Departemen
                            </span>
                            <span class="text-slate-400 ml-2">sedang membuka</span>
                        </div>
                    </div>

                    <!-- Card 3 -->
                    <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Menunggu Review</p>
                                <h3 id="menungguReview" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-amber-50 text-amber-600 rounded-lg">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="text-amber-600 font-medium">Perlu tindakan</span>
                        </div>
                    </div>

                    <!-- Card 4 -->
                    <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Tingkat Penerimaan</p>
                                <h3 id="tingkatPenerimaan" class="text-3xl font-bold text-slate-800 mt-1">0%</h3>
                            </div>
                            <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="text-slate-400">Total Diterima: </span>
                            <span id="totalApproved" class="text-slate-700 font-semibold ml-1">0</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Main Chart: Trends -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-semibold text-slate-800">Tren Pendaftaran (30 Hari Terakhir)</h3>
                            <select class="text-sm border-slate-200 rounded-lg text-slate-500 focus:ring-primary-500 focus:border-primary-500 p-1">
                                <option>30 Hari</option>
                                <option>7 Hari</option>
                                <option>Tahun Ini</option>
                            </select>
                        </div>
                        <div class="h-64">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <!-- Side Chart: Department Distribution -->
                    <div class="bg-white p-6 rounded-xl card-shadow border border-slate-100">
                        <h3 class="font-semibold text-slate-800 mb-6">Pendaftar per Departemen</h3>
                        <div class="h-64 relative flex items-center justify-center">
                            <canvas id="deptChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Table -->
                <div class="bg-white rounded-xl card-shadow border border-slate-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-semibold text-slate-800">Pendaftar Terbaru</h3>
                        <a href="/dashboard/manajemen-pendaftar/" class="text-sm text-primary-600 hover:text-primary-700 font-medium">Lihat Semua</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nama Pendaftar</th>
                                    <th scope="col" class="px-6 py-3">Posisi Dilamar</th>
                                    <th scope="col" class="px-6 py-3">Universitas</th>
                                    <th scope="col" class="px-6 py-3">Tanggal</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="recentApplicantsBody" class="divide-y divide-slate-100">
                                <!-- Data akan dimuat via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </main>

    <!-- MODAL REVIEW (Pending - dengan action) -->
    <div id="modalReview" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal('modalReview')"></div>
        
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-200">
                    
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-slate-50 to-white px-6 py-4 border-b border-slate-200 flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800" id="modalReviewName">-</h3>
                            <p class="text-sm text-slate-500" id="modalReviewPosition">-</p>
                        </div>
                        <button onclick="closeModal('modalReview')" class="text-slate-400 hover:text-slate-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Info -->
                            <div class="space-y-4">
                                <h4 class="text-sm font-semibold text-slate-700 pb-2 border-b border-slate-200">Data Pribadi</h4>
                                <div id="modal-personal-info" class="space-y-3"></div>
                            </div>
                            
                            <!-- Academic Info -->
                            <div class="space-y-4">
                                <h4 class="text-sm font-semibold text-slate-700 pb-2 border-b border-slate-200">Data Akademik</h4>
                                <div id="modal-academic-info" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer (Actions) -->
                    <div class="bg-slate-50 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 border-t border-slate-200">
                        <p class="text-sm text-slate-500">
                            Periksa data dengan teliti sebelum mengambil keputusan
                        </p>
                        <div class="flex gap-3 w-full sm:w-auto">
                            <button type="button" onclick="handleDecision('rejected')" class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-red-700 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                                Tolak
                            </button>
                            <button type="button" onclick="handleDecision('approved')" class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                                Terima
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VIEW (History - view only, no action buttons) -->
    <div id="modalView" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-view-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal('modalView')"></div>
        
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-200">
                    
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-slate-50 to-white px-6 py-4 border-b border-slate-200 flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3">
                                <h3 class="text-lg font-semibold text-slate-800" id="modalViewName">-</h3>
                                <span id="modalViewStatus" class="px-2 py-0.5 rounded-full text-xs font-medium">-</span>
                            </div>
                            <p class="text-sm text-slate-500" id="modalViewPosition">-</p>
                        </div>
                        <button onclick="closeModal('modalView')" class="text-slate-400 hover:text-slate-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Info -->
                            <div class="space-y-4">
                                <h4 class="text-sm font-semibold text-slate-700 pb-2 border-b border-slate-200">Data Pribadi</h4>
                                <div id="modalView-personal-info" class="space-y-3"></div>
                            </div>
                            
                            <!-- Academic Info -->
                            <div class="space-y-4">
                                <h4 class="text-sm font-semibold text-slate-700 pb-2 border-b border-slate-200">Data Akademik</h4>
                                <div id="modalView-academic-info" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer (No action buttons) -->
                    <div class="bg-slate-50 px-6 py-4 flex justify-end border-t border-slate-200">
                        <button type="button" onclick="closeModal('modalView')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">
                            Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let trendChart = null;
        let deptChart = null;
        let currentTransaksiId = null;

        // Load Statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/dashboard/api/stats/');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('totalPendaftar').textContent = data.total_pendaftar.toLocaleString();
                    document.getElementById('lowonganAktif').textContent = data.lowongan_aktif;
                    document.getElementById('deptAktif').textContent = data.dept_aktif;
                    document.getElementById('menungguReview').textContent = data.menunggu_review;
                    document.getElementById('tingkatPenerimaan').textContent = data.tingkat_penerimaan + '%';
                    document.getElementById('totalApproved').textContent = data.total_approved;
                    
                    // Update perubahan pendaftar
                    const perubahanElem = document.getElementById('perubahanPendaftar');
                    const perubahan = data.persentase_perubahan;
                    if (perubahan >= 0) {
                        perubahanElem.className = 'text-green-500 font-medium flex items-center gap-1';
                        perubahanElem.innerHTML = `<i data-lucide="trending-up" class="w-3 h-3"></i> +${perubahan}%`;
                    } else {
                        perubahanElem.className = 'text-red-500 font-medium flex items-center gap-1';
                        perubahanElem.innerHTML = `<i data-lucide="trending-down" class="w-3 h-3"></i> ${perubahan}%`;
                    }
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Trend Chart
        async function loadTrendChart() {
            try {
                const response = await fetch('/dashboard/api/trend/');
                const result = await response.json();
                
                if (result.success) {
                    const ctxTrend = document.getElementById('trendChart').getContext('2d');
                    trendChart = new Chart(ctxTrend, {
                        type: 'line',
                        data: {
                            labels: result.data.labels,
                            datasets: [{
                                label: 'Pendaftar Masuk',
                                data: result.data.data,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#3b82f6',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { borderDash: [2, 4], color: '#f1f5f9' },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif" } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif" } }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading trend chart:', error);
            }
        }

        // Load Department Chart
        async function loadDepartmentChart() {
            try {
                const response = await fetch('/dashboard/api/department/');
                const result = await response.json();
                
                if (result.success) {
                    const ctxDept = document.getElementById('deptChart').getContext('2d');
                    const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#64748b', '#ec4899', '#06b6d4'];
                    
                    deptChart = new Chart(ctxDept, {
                        type: 'doughnut',
                        data: {
                            labels: result.data.labels,
                            datasets: [{
                                data: result.data.data,
                                backgroundColor: colors.slice(0, result.data.labels.length),
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: { family: "'Plus Jakarta Sans', sans-serif", size: 12 }
                                    }
                                }
                            },
                            cutout: '75%',
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading department chart:', error);
            }
        }

        // Load Recent Applicants
        async function loadRecentApplicants() {
            try {
                const response = await fetch('/dashboard/api/recent-applicants/?limit=10');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('recentApplicantsBody');
                    
                    if (result.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                                    Belum ada data pendaftar
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const avatarColors = {
                        'pending': 'bg-amber-100 text-amber-600',
                        'approved': 'bg-green-100 text-green-600',
                        'rejected': 'bg-red-100 text-red-600'
                    };
                    
                    const statusBadges = {
                        'pending': 'bg-amber-100 text-amber-800 border-amber-200',
                        'approved': 'bg-green-100 text-green-800 border-green-200',
                        'rejected': 'bg-red-100 text-red-800 border-red-200'
                    };
                    
                    const statusText = {
                        'pending': 'Pending',
                        'approved': 'Diterima',
                        'rejected': 'Ditolak'
                    };
                    
                    tbody.innerHTML = result.data.map(applicant => `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-slate-900">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full ${avatarColors[applicant.status]} flex items-center justify-center text-xs font-bold">
                                        ${applicant.initials}
                                    </div>
                                    <div>${applicant.name}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4">${applicant.position}</td>
                            <td class="px-6 py-4">${applicant.university}</td>
                            <td class="px-6 py-4">${applicant.date}</td>
                            <td class="px-6 py-4">
                                <span class="${statusBadges[applicant.status]} text-xs font-medium px-2.5 py-0.5 rounded-full border">
                                    ${statusText[applicant.status]}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                ${applicant.status === 'pending' ? `
                                    <button onclick="openReviewModal(${applicant.id_transaksi})" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-xs font-semibold rounded-lg transition-colors shadow-sm">
                                        Review Lamaran <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    </button>
                                ` : `
                                    <button onclick="openViewModal(${applicant.id_transaksi})" class="p-2 text-slate-400 hover:text-primary-600 transition-colors" title="Lihat Detail">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                `}
                            </td>
                        </tr>
                    `).join('');
                    
                    console.log('Loaded', result.data.length, 'applicants');
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading recent applicants:', error);
            }
        }

        // === MODAL FUNCTIONS ===
        async function openReviewModal(idTransaksi) {
            console.log('Opening review modal for:', idTransaksi);
            currentTransaksiId = idTransaksi;
            
            try {
                const response = await fetch(`/dashboard/api/pendaftar/detail/${idTransaksi}/`);
                const result = await response.json();
                console.log('Review modal data:', result);

                if (result.success) {
                    const data = result.data;
                    
                    // Set header
                    document.getElementById('modalReviewName').textContent = data.nama;
                    document.getElementById('modalReviewPosition').textContent = data.posisi;
                    
                    // Set personal info
                    document.getElementById('modal-personal-info').innerHTML = `
                        <div>
                            <p class="text-xs text-slate-500">NIK</p>
                            <p class="font-medium text-slate-800">${data.nik}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Jenis Kelamin</p>
                            <p class="font-medium text-slate-800">${data.jenis_kelamin}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Tanggal Lahir</p>
                            <p class="font-medium text-slate-800">${data.tanggal_lahir}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">No. Telepon</p>
                            <p class="font-medium text-slate-800">${data.no_telp}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Alamat</p>
                            <p class="font-medium text-slate-800 text-sm leading-relaxed">${data.alamat}</p>
                        </div>
                    `;
                    
                    // Set academic info
                    document.getElementById('modal-academic-info').innerHTML = `
                        <div>
                            <p class="text-xs text-slate-500">Universitas</p>
                            <p class="font-medium text-slate-800">${data.universitas}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Jurusan</p>
                            <p class="font-medium text-slate-800">${data.jurusan}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">IPK</p>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-sm font-bold bg-green-50 text-green-700 border border-green-200">
                                ${data.ipk || 'N/A'} ${data.ipk ? '/ 4.00' : ''}
                            </span>
                        </div>
                        <div class="pt-4">
                            <p class="text-xs text-slate-500 mb-2">Curriculum Vitae</p>
                            ${data.cv_url ? `
                            <a href="${data.cv_url}" target="_blank" class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:border-primary-300 hover:shadow-sm transition-all group">
                                <div class="bg-red-100 p-2 rounded text-red-600">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-700 group-hover:text-primary-700">${data.cv_filename}</p>
                                    <p class="text-xs text-slate-400">PDF</p>
                                </div>
                                <i data-lucide="download" class="w-4 h-4 text-slate-400 group-hover:text-primary-600"></i>
                            </a>
                            ` : `
                            <div class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50">
                                <div class="bg-slate-200 p-2 rounded text-slate-400">
                                    <i data-lucide="file-x" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-500">CV tidak tersedia</p>
                                    <p class="text-xs text-slate-400">Belum diunggah</p>
                                </div>
                            </div>
                            `}
                        </div>
                    `;
                    
                    lucide.createIcons();
                    document.getElementById('modalReview').classList.remove('hidden');
                } else {
                    showToast(result.message || 'Gagal memuat detail', 'error');
                }
            } catch (error) {
                console.error('Error loading detail:', error);
                showToast('Terjadi kesalahan saat memuat detail', 'error');
            }
        }

        async function openViewModal(idTransaksi) {
            console.log('Opening view modal for:', idTransaksi);
            
            try {
                const response = await fetch(`/dashboard/api/pendaftar/detail/${idTransaksi}/`);
                const result = await response.json();
                console.log('View modal data:', result);

                if (result.success) {
                    const data = result.data;
                    
                    // Set header
                    document.getElementById('modalViewName').textContent = data.nama;
                    document.getElementById('modalViewPosition').textContent = data.posisi;
                    
                    // Set status badge
                    const statusBadge = document.getElementById('modalViewStatus');
                    if (data.status === 'approved') {
                        statusBadge.className = 'px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200';
                        statusBadge.textContent = 'Diterima';
                    } else if (data.status === 'rejected') {
                        statusBadge.className = 'px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 border border-red-200';
                        statusBadge.textContent = 'Ditolak';
                    }
                    
                    // Set personal info
                    document.getElementById('modalView-personal-info').innerHTML = `
                        <div>
                            <p class="text-xs text-slate-500">NIK</p>
                            <p class="font-medium text-slate-800">${data.nik}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Jenis Kelamin</p>
                            <p class="font-medium text-slate-800">${data.jenis_kelamin}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Tanggal Lahir</p>
                            <p class="font-medium text-slate-800">${data.tanggal_lahir}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">No. Telepon</p>
                            <p class="font-medium text-slate-800">${data.no_telp}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Alamat</p>
                            <p class="font-medium text-slate-800 text-sm leading-relaxed">${data.alamat}</p>
                        </div>
                    `;
                    
                    // Set academic info
                    document.getElementById('modalView-academic-info').innerHTML = `
                        <div>
                            <p class="text-xs text-slate-500">Universitas</p>
                            <p class="font-medium text-slate-800">${data.universitas}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Jurusan</p>
                            <p class="font-medium text-slate-800">${data.jurusan}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">IPK</p>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-sm font-bold bg-green-50 text-green-700 border border-green-200">
                                ${data.ipk || 'N/A'} ${data.ipk ? '/ 4.00' : ''}
                            </span>
                        </div>
                        <div class="pt-4">
                            <p class="text-xs text-slate-500 mb-2">Curriculum Vitae</p>
                            ${data.cv_url ? `
                            <a href="${data.cv_url}" target="_blank" class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:border-primary-300 hover:shadow-sm transition-all group">
                                <div class="bg-red-100 p-2 rounded text-red-600">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-700 group-hover:text-primary-700">${data.cv_filename}</p>
                                    <p class="text-xs text-slate-400">PDF</p>
                                </div>
                                <i data-lucide="download" class="w-4 h-4 text-slate-400 group-hover:text-primary-600"></i>
                            </a>
                            ` : `
                            <div class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50">
                                <div class="bg-slate-200 p-2 rounded text-slate-400">
                                    <i data-lucide="file-x" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-500">CV tidak tersedia</p>
                                    <p class="text-xs text-slate-400">Belum diunggah</p>
                                </div>
                            </div>
                            `}
                        </div>
                    `;
                    
                    lucide.createIcons();
                    document.getElementById('modalView').classList.remove('hidden');
                } else {
                    showToast(result.message || 'Gagal memuat detail', 'error');
                }
            } catch (error) {
                console.error('Error loading detail:', error);
                showToast('Terjadi kesalahan saat memuat detail', 'error');
            }
        }

        async function handleDecision(status) {
            if (!currentTransaksiId) return;
            
            const statusText = status === 'approved' ? 'menerima' : 'menolak';
            if (!confirm(`Yakin ingin ${statusText} kandidat ini?`)) return;

            try {
                const response = await fetch(`/dashboard/api/pendaftar/${currentTransaksiId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message || `Berhasil ${statusText} kandidat`, 'success');
                    closeModal('modalReview');
                    await loadRecentApplicants();
                    await loadStatistics();
                } else {
                    showToast(result.message || `Gagal ${statusText} kandidat`, 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Terjadi kesalahan saat memproses', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            currentTransaksiId = null;
        }

        // === UTILITY FUNCTIONS ===
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const toast = document.createElement('div');
            toast.className = `fixed top-5 right-5 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-[110] transition-opacity`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // View applicant detail (for non-pending applicants) - REMOVED (replaced with openViewModal)

        // Initialize Dashboard
        async function initDashboard() {
            await loadStatistics();
            await loadTrendChart();
            await loadDepartmentChart();
            await loadRecentApplicants();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
{% endblock %}